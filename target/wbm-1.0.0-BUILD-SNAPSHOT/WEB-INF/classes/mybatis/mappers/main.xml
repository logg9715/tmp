<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
      PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.main">
	<select id="select_sales_type" resultType="java.util.Map">
		select tst_name,tst_code from tbl_sales_type order by tst_name asc
	</select>
	
	<select id="select_product_company" resultType="java.util.Map">
		select * from tbl_product_company order by tpc_code desc
	</select>
	
	<select id="select_work_company" resultType="java.util.Map">
		select * from tbl_work_company order by twc_code desc
	</select>
	
	<select id="select_contract_datacount" resultType="int" parameterType="java.util.Map">
	 	select count(tsi.tsi_code) from tbl_sales_info as tsi
  		inner join tbl_manager_info on tsi_tmicode=tmi_code 
  		left outer join tbl_sales_type on tst_code=tsi_tstcode
  		where tsi_code is not null
  		<choose>
  			<when test="userLevel == null or userLevel lte 70"> and tsi_confirm_level = 0 and tsi_tmicode=${userCode}</when>
<!--   			<when test="userLevel != null and userLevel == 80"> <![CDATA[ and tsi_tgicode=${groupCode} and tsi_confirm_level <= 1 ]]></when> -->
  			<when test="userLevel != null and userLevel == 80"> and tsi_tgicode=${groupCode}</when>
  			<when test="userLevel != null and userLevel > 80"> and tsi_confirm_level = 2</when>
		</choose>
  		<choose>
			<when test = "sel_search_word != null and sel_search_word == 1">
				 and tsi_contract_date like ('%' + #{txt_search_word} + '%')
			</when>
			<when test = "sel_search_word != null and sel_search_word == 2">
				 and tsi_demand_name like ('%' + #{txt_search_word} + '%')
			</when>
			<when test = "sel_search_word != null and sel_search_word == 3">
				 and tsi_order_name like ('%' + #{txt_search_word} + '%')
			</when>
			<when test = "sel_search_word != null and sel_search_word == 4">
				 and tsi_bus_name like ('%' + #{txt_search_word} + '%')
			</when>
			<when test = "sel_search_word != null and sel_search_word == 5">
				 and tst_name like ('%' + #{txt_search_word} + '%')
			</when>
		</choose>
		<if test = "sel_search_company != null and sel_search_company > 0 ">
			 and tsi_tpccode = ${sel_search_company}
		</if>
		<if test = "txt_bus_sdate != null and txt_bus_sdate != ''">  	
			<![CDATA[			
			and #{txt_bus_sdate}>=tsi_bus_starttm
			]]>
		</if>
		<if test = "txt_bus_edate != null and txt_bus_edate != ''">
			<![CDATA[  				
			and #{txt_bus_edate}<=tsi_bus_endtm
			]]>
		</if>
	</select>
	
	<select id="select_contract_data" resultType="java.util.Map" parameterType="java.util.Map">
		select tpc_name,tsi.*,tmi_name,tst_name,convert(varchar(19),tsi_regdate,121) as regDate,
		(select count(tiw_code) from tbl_install_work where tiw_tsicode=tsi.tsi_code) work_count,
		(select count(tpp_code) from tbl_purchase_product where tpp_tsicode=tsi.tsi_code) purchase_count,
   	   	datediff(day,getdate(),cast(tsi_bus_endtm as date)) day_diff from tbl_sales_info as tsi
  		inner join tbl_manager_info on tsi_tmicode=tmi_code 
  		left outer join tbl_pay_company on tpc_code=tsi_tpccode
  		left outer join tbl_sales_type on tst_code=tsi_tstcode 
  		where tsi_code is not null
  		<choose>
  			<when test="userLevel == null or userLevel lte 70"> and tsi_confirm_level=0 and tsi_tmicode=${userCode}</when>
<!--   			<when test="userLevel != null and userLevel == 80"> <![CDATA[ and tsi_tgicode=${groupCode} and tsi_confirm_level <= 1 ]]></when> -->
  			<when test="userLevel != null and userLevel == 80"> and tsi_tgicode=${groupCode}</when>
  			<when test="userLevel != null and userLevel > 80"> and tsi_confirm_level = 2</when>
		</choose>
  		<choose>
			<when test = "sel_search_word != null and sel_search_word == 1">
				 and tsi_contract_date like ('%' + #{txt_search_word} + '%')
			</when>
			<when test = "sel_search_word != null and sel_search_word == 2">
				 and tsi_demand_name like ('%' + #{txt_search_word} + '%')
			</when>
			<when test = "sel_search_word != null and sel_search_word == 3">
				 and tsi_order_name like ('%' + #{txt_search_word} + '%')
			</when>
			<when test = "sel_search_word != null and sel_search_word == 4">
				 and tsi_bus_name like ('%' + #{txt_search_word} + '%')
			</when>
			<when test = "sel_search_word != null and sel_search_word == 5">
				 and tst_name like ('%' + #{txt_search_word} + '%')
			</when>
		</choose>
		<if test = "sel_search_company != null and sel_search_company > 0 ">
			 and tsi_tpccode = ${sel_search_company}
		</if>
		<if test = "txt_bus_sdate != null and txt_bus_sdate != ''">  	
			<![CDATA[			
			and #{txt_bus_sdate}>=tsi_bus_starttm
			]]>
		</if>
		<if test = "txt_bus_edate != null and txt_bus_edate != ''">
			<![CDATA[  				
			and #{txt_bus_edate}<=tsi_bus_endtm
			]]>
		</if>
  		<choose>
			<when test="sortInfo != null and sortInfo.size() > 0">
	        	order by
	        	<foreach index="idx" collection="sortInfo" item="order" separator=",">
		        	<choose>
		                <when test="order==0 and idx==0">
	                    	tsi_contract_date asc
		                </when>
		                <when test="order==1 and idx==0">
	                    	tsi_contract_date desc
		                </when>
		            </choose>
		        	<choose>
		                <when test="order==0 and idx==1">
	                    	tsi_demand_name asc
		                </when>
		                <when test="order==1 and idx==1">
	                    	tsi_demand_name desc
		                </when>
		            </choose>
		        	<choose>
		                <when test="order==0 and idx==2">
	                    	tsi_order_name asc
		                </when>
		                <when test="order==1 and idx==2">
	                    	tsi_order_name desc
		                </when>
		            </choose>
		        	<choose>
		                <when test="order==0 and idx==3">
	                    	tsi_bus_name asc
		                </when>
		                <when test="order==1 and idx==3">
	                    	tsi_bus_name desc
		                </when>
		            </choose>
		        	<choose>
		                <when test="order==0 and idx==4">
	                    	cast(tsi_contract_price as int) asc
		                </when>
		                <when test="order==1 and idx==4">
	                    	cast(tsi_contract_price as int) desc
		                </when>
		            </choose>
	        	</foreach>
<!-- 	            ,tsi_confirm_level desc,tsi_code asc -->
	        </when>
	        <otherwise>
	        	order by tsi_code asc
	        </otherwise>
	    </choose>
  		<!-- 
  		<if test="exportExcel = null or exportExcel != 1">
 			offset((${pageIndex}-1)*${listCount}) row fetch next ${listCount} row only
 		</if>
 		 --> 
	</select>
  
	<update id="update_sales_info" parameterType="java.util.Map">
		update tbl_sales_info set 
			tsi_tstcode=${salesUserCate},
           	tsi_demand_name=#{salesDemand},
           	tsi_order_name=#{salesOrder},
			tsi_bus_name=#{salesBusName}, 
			tsi_contract_price=#{salesContractPrice},
			tsi_contract_vat=#{salesContractVat},
			tsi_bus_starttm=#{salesBusSTime},
			tsi_bus_endtm=#{salesBusETime},
			tsi_as_starttm=#{salesServiceSTime},
			tsi_as_endtm=#{salesServiceETime},
			tsi_etc=#{salesComment},
			tsi_mod_regdate=getdate(),
			tsi_mod_tmicode=${userCode}
			where tsi_code=${salesCode}
	</update>	
	
	<insert id="inser_sales_info" parameterType="java.util.Map" useGeneratedKeys="true" keyProperty="autoTsiCode">
		insert into tbl_sales_info(
			tsi_tstcode,
			tsi_demand_name,
			tsi_order_name,
			tsi_bus_name,
			tsi_contract_price,
  			tsi_contract_vat,
  			tsi_bus_starttm,
  			tsi_bus_endtm,
  			tsi_as_starttm,
  			tsi_as_endtm,
  			tsi_etc,
  			tsi_tmicode,
  			tsi_tgicode,
  			tsi_confirm_level)
		values(
	        ${salesUserCate},
	        #{salesDemand},
	        #{salesOrder},
	        #{salesBusName},
	        #{salesContractPrice},
	        #{salesContractVat},
	        #{salesBusSTime},
	        #{salesBusETime},
	        #{salesServiceSTime},
	        #{salesServiceETime},
	        #{salesComment},
	        ${userCode},
	        #{groupCode},
	        0)
	</insert> 
	
	<insert id="insert_file_info" parameterType="java.util.Map">
		insert into tbl_file_info(
	            tfi_parent_code,
	            tfi_res_name,
	            tfi_file_name,
	            tfi_parent_tblname)
			values ( 
			    #{parentCode},
			  	#{resImgName},
			  	#{targetImgName},
			  	#{parentTblName})	
	</insert>	
	
	<delete id="delete_file_info"  parameterType="java.util.Map"> 
		delete from tbl_file_info where tfi_parent_tblname=#{parentTblName} and tfi_parent_code=#{parentCode}
   	</delete>
   	
  	<select id="select_sales_detail" resultType="java.util.Map" parameterType="int">
		select top 1 * from tbl_sales_info where tsi_code=${value}
	</select>
	
  	<select id="select_file_data" resultType="java.util.Map" parameterType="java.util.Map">
		select * from tbl_file_info where tfi_parent_code=${parentCode} and tfi_parent_tblname=#{parentTblName}
	</select>   
	
	<delete id="delete_file_code" parameterType="list">
		delete from tbl_file_info where tfi_code in
		<foreach item="code" collection="list" open="(" separator="," close=")">
			${code}
		</foreach>
	</delete>	
	
  	<delete id="delete_sales_info" parameterType="int">
		delete from tbl_file_info where tfi_parent_code=${value} and tfi_parent_tblname='tbl_sales_info';
		delete from tbl_sales_info where tsi_code=${value}
	</delete>
	
	<update id="update_contract_info" parameterType="java.util.Map">
		update tbl_sales_info set 
			tsi_tpccode=${contractCompany},
			tsi_tstcode=${contractUserCate},
           	tsi_demand_name=#{contractDemand},
           	tsi_order_name=#{contractOrder},
			tsi_bus_name=#{contractBusName}, 
			tsi_contract_price=#{contractPrice},
			tsi_contract_vat=#{contractVat},
			tsi_bus_starttm=#{contractBusSTime},
			tsi_bus_endtm=#{contractBusETime},
			tsi_as_starttm=#{contractServiceSTime},
			tsi_as_endtm=#{contractServiceETime},
			tsi_etc=#{contractInfoMemo},
			tsi_mod_regdate=getdate(),
			tsi_mod_tmicode=${userCode},
			tsi_contract_date=#{contractDate},
  			tsi_send_contract=${contractSend},
  			tsi_confirm_level=${confirmLevel}
			where tsi_code=${salesCode}
	</update>	
	
	<insert id="inser_contract_info" parameterType="java.util.Map" useGeneratedKeys="true" keyProperty="autoTsiCode">
		insert into tbl_sales_info(
			tsi_tpccode,
			tsi_tstcode,
			tsi_demand_name,
			tsi_order_name,
			tsi_bus_name,
			tsi_contract_price,
  			tsi_contract_vat,
  			tsi_bus_starttm,
  			tsi_bus_endtm,
  			tsi_as_starttm,
  			tsi_as_endtm,
  			tsi_etc,
  			tsi_tmicode,
  			tsi_tgicode,
  			tsi_contract_date,
  			tsi_send_contract,
  			tsi_confirm_level)
		values(
			${contractCompany},
	        ${contractUserCate},
	        #{contractDemand},
	        #{contractOrder},
	        #{contractBusName},
	        #{contractPrice},
	        #{contractVat},
	        #{contractBusSTime},
	        #{contractBusETime},
	        #{contractServiceSTime},
	        #{contractServiceETime},
	        #{contractInfoMemo},
	        ${userCode}, 
	        #{groupCode},
	        #{contractDate},
	        ${contractSend},
	        ${confirmLevel})
	</insert>    
	
	<update id="update_read_sales" parameterType="java.util.Map">
		<![CDATA[		
		update tbl_sales_info set tsi_read_level=${readLevel} where tsi_code=${parentCode} and (tsi_read_level is null or tsi_read_level<${readLevel})
		]]>
	</update>
	
	<update id="update_sales_datastep" parameterType="java.util.Map">
		update tbl_sales_info set tsi_confirm_level=${level},tsi_confirm_date=getdate(),tsi_edit_tmicode=${userCode},tsi_edit_regdate=getdate() where tsi_code=${salesCode}
	</update>
	
	<select id="select_contract_readymoney" parameterType="int" resultType="java.util.Map">
		select * from tbl_pay_info where tpi_tsicode=${value}
	</select>
	
	<delete id="delete_contract_readymoney"  parameterType="int"> 
		delete from tbl_pay_info where tpi_tsicode=${value}
   	</delete>
   	
	<insert id="insert_contract_readymoney" parameterType="java.util.Map">
		insert into tbl_pay_info(
			tpi_tmicode,
			tpi_tsicode,
			tpi_type,
			tpi_price,
			tpi_price_vat,
			tpi_sales_type,
			tpi_request_date,
			tpi_response_date,
			tpi_confirm_level,
			tpi_collection,
			tpi_pay_type,
			tpi_pay_check,
			tpi_tpccode,
			tpi_etc)
		values(
	        ${userCode},
	        ${contractCode},
	        ${payContractType},
	        #{payContractPrice},
	        #{payContractPriceVat},
	        #{contractSalesType},
	        #{contractRequestBillDate},
	        #{contractResponseBillDate},
	        #{confirmLevel},
	        #{payCollect},
	        #{payBillType},
	        #{payCheck},
	        #{payCompanyCode},
	        #{contractMemo})
	</insert>
	
	<delete id="delete_contract_pay" parameterType="int">
		delete from tbl_file_info where tfi_parent_code=${value} and tfi_parent_tblname='tbl_contract_info'; 
  		delete from tbl_pay_info where tpi_tsicode=${value};
	</delete>
	
	<delete id="delete_contract_info" parameterType="int">
  		delete from tbl_sales_info where tsi_code=${value}
	</delete>

	<select id="select_contract_iteminfo" parameterType="int" resultType="int">
		select tci_code from tbl_contract_info where tci_tsicode=${value}
	</select>
	
	<select id="select_contract_detailinfo" parameterType="int" resultType="java.util.Map">
		select top 1 * from tbl_contract_info where tci_code=${value}
	</select>
	 
	<delete id="delete_contract_iteminfo" parameterType="int">
    	delete from tbl_purchase_product where tpp_tsicode=${value};
	    delete from tbl_contract_memo where tcm_tcicode=${value};
    	delete from tbl_install_work where tiw_tsicode=${value};
		delete from tbl_file_info where tfi_parent_code=${value} and tfi_parent_tblname='tbl_contract_item';
<!-- 		delete from tbl_contract_info where tci_code=${value}; -->
	</delete>
	
	<select id="select_contract_paycompany" resultType="java.util.Map">
		select * from tbl_pay_company
	</select>

	<update id="update_bill_publication" parameterType="java.util.Map">
		update tbl_bill_publication set 
			tbp_tsicode=${salesCode},
			tbp_tmicode=${userCode},
			tbp_tpccode=${payContractCompany},
           	tbp_bill_pubdate=#{payContractReponseDate},
			tbp_memo=#{adminMemo},
			tbp_bill_pubcanceldate=getdate(),
			tbp_bill_pubtype=${billType},
			tbp_is_collection=${payCollect}
			where tbp_code=${billCode}
	</update>
	
	<insert id="insert_bill_publication" parameterType="java.util.Map" useGeneratedKeys="true" keyProperty="autoTbpCode">
		insert into tbl_bill_publication ( 
			tbp_tsicode,
			tbp_tmicode,
			tbp_tpccode,
           	tbp_bill_pubdate,
			tbp_memo,
			tbp_bill_pubcanceldate,
			tbp_bill_pubtype,
			tbp_is_collection
		) 
		values(
			${salesCode},	
			${userCode},
			${payContractCompany},
			#{payContractReponseDate},
			#{adminMemo},
			getdate(),
			${billType},
			${payCollect}
		)
	</insert>
	
  	<select id="select_billpublication_detail" resultType="java.util.Map" parameterType="int">
		select top 1 * from tbl_bill_publication where tbp_tsicode=${value}
	</select>

	<select id="select_productname_info" resultType="java.util.Map">
		select * from tbl_product_info order by tpi_code desc
	</select>
		
	<select id="select_workname_info" resultType="java.util.Map">
		select * from tbl_work_info order by twi_code desc
	</select>
	
	<select id="select_product_info" resultType="java.util.Map" parameterType="int">
		select * from tbl_purchase_product
<!--     	left outer join tbl_product_info on tpi_code=tpp_tpicode -->
<!--     	left outer join tbl_product_company on tpc_code=tpp_tpccode -->
    	where tpp_tsicode=${value}
	</select>
	
	<select id="select_product_detail" resultType="java.util.Map" parameterType="int">
		select top 1 * from tbl_purchase_product
    	where tpp_code=${value}
	</select>
		
	<select id="select_work_info" resultType="java.util.Map" parameterType="int">
		select * from tbl_install_work
<!--     	left outer join tbl_work_info on twi_code=tiw_twicode -->
<!--     	left outer join tbl_work_company on twc_code=tiw_twccode  -->
    	where tiw_tsicode=${value}
	</select>
	
	<select id="select_work_detail" resultType="java.util.Map" parameterType="int">
		select top 1 * from tbl_install_work
    	where tiw_code=${value}
	</select>
	
	<select id="select_revenue_count" resultType="int" parameterType="java.util.Map">
		select count(tsi_code) from tbl_sales_info 
		left outer join tbl_pay_info on tpi_tsicode=tsi_code
		left outer join tbl_pay_company on tpi_tpccode=tpc_code 
		left outer join tbl_sales_type on tst_code=tsi_tstcode 
		<![CDATA[			
		where tsi_confirm_level is not null and tsi_confirm_level >= 3
		]]> 
		
		<choose>
			<when test = "sel_search_word != null and sel_search_word == 1">
				 and tsi_contract_date like ('%' + #{txt_search_word} + '%')
			</when>
			<when test = "sel_search_word != null and sel_search_word == 2">
				 and tsi_demand_name like ('%' + #{txt_search_word} + '%')
			</when>
			<when test = "sel_search_word != null and sel_search_word == 3">
				 and tsi_order_name like ('%' + #{txt_search_word} + '%')
			</when>
			<when test = "sel_search_word != null and sel_search_word == 4">
				 and tsi_bus_name like ('%' + #{txt_search_word} + '%')
			</when>
			<when test = "sel_search_word != null and sel_search_word == 5">
				 and tpi_collection like ('%' + #{txt_search_word} + '%')
			</when>
		</choose>
		
		<if test = "userLevel != null and userLevel &lt;= 80 ">
			 and tsi_tgicode=${userGroup}
		</if>
		<if test = "sel_search_company != null and sel_search_company > 0 ">
			 and tpi_tpccode = ${sel_search_company}
		</if>
		<if test = "txt_bus_sdate != null and txt_bus_sdate != ''">  	
			<![CDATA[			
			and #{txt_bus_sdate}>=tsi_bus_starttm
			]]>
		</if>
		<if test = "txt_bus_edate != null and txt_bus_edate != ''">
			<![CDATA[  				
			and #{txt_bus_edate}<=tsi_bus_endtm
			]]>
		</if>
	</select>	
	
	<select id="select_revenue_data" resultType="java.util.Map" parameterType="java.util.Map">
		select *,
		(select count(tiw_code) from tbl_install_work where tiw_tsicode=tsi.tsi_code) work_count,
		(select count(tpp_code) from tbl_purchase_product where tpp_tsicode=tsi.tsi_code) purchase_count from tbl_sales_info as tsi 
		left outer join tbl_pay_info on tpi_tsicode=tsi_code
		left outer join tbl_pay_company on tpi_tpccode=tpc_code 
		left outer join tbl_sales_type on tst_code=tsi_tstcode 
		<![CDATA[			
		where tsi_confirm_level is not null and tsi_confirm_level >= 3
		]]> 		
		<choose>
			<when test = "sel_search_word != null and sel_search_word == 1">
				 and tsi_contract_date like ('%' + #{txt_search_word} + '%')
			</when>
			<when test = "sel_search_word != null and sel_search_word == 2">
				 and tsi_demand_name like ('%' + #{txt_search_word} + '%')
			</when>
			<when test = "sel_search_word != null and sel_search_word == 3">
				 and tsi_order_name like ('%' + #{txt_search_word} + '%')
			</when>
			<when test = "sel_search_word != null and sel_search_word == 4">
				 and tsi_bus_name like ('%' + #{txt_search_word} + '%')
			</when>
			<when test = "sel_search_word != null and sel_search_word == 5">
				 and tpi_collection like ('%' + #{txt_search_word} + '%')
			</when>
		</choose>
		
		<if test = "userLevel != null and userLevel &lt;= 80 ">
			 and tsi_tgicode=${userGroup}
		</if>
		<if test = "sel_search_company != null and sel_search_company > 0 ">
			 and tpi_tpccode = ${sel_search_company}
		</if>
		<if test = "txt_bus_sdate != null and txt_bus_sdate != ''">  	
			<![CDATA[			
			and #{txt_bus_sdate}>=tsi_bus_starttm
			]]>
		</if>
		<if test = "txt_bus_edate != null and txt_bus_edate != ''">
			<![CDATA[  				
			and #{txt_bus_edate}<=tsi_bus_endtm
			]]>
		</if>
		<if test = "num_bill_year != null and num_bill_year > 0">
			and left(tpi_response_date,4)=#{num_bill_year}
		</if>
		<choose>
			<when test="sortInfo != null and sortInfo.size() > 0">
	        	order by
	        	<foreach index="idx" collection="sortInfo" item="order" separator=",">
		        	<choose>
		                <when test="order==0 and idx==0">
	                    	tsi_contract_date asc
		                </when>
		                <when test="order==1 and idx==0">
	                    	tsi_contract_date desc
		                </when>
		            </choose>
		        	<choose>
		                <when test="order==0 and idx==1">
	                    	tsi_demand_name asc
		                </when>
		                <when test="order==1 and idx==1">
	                    	tsi_demand_name desc
		                </when>
		            </choose>
		        	<choose>
		                <when test="order==0 and idx==2">
	                    	tsi_order_name asc
		                </when>
		                <when test="order==1 and idx==2">
	                    	tsi_order_name desc
		                </when>
		            </choose>
		        	<choose>
		                <when test="order==0 and idx==3">
	                    	tsi_bus_name asc
		                </when>
		                <when test="order==1 and idx==3">
	                    	tsi_bus_name desc
		                </when>
		            </choose>
		        	<choose>
		                <when test="order==0 and idx==4">
	                    	tsi_contract_price asc
		                </when>
		                <when test="order==1 and idx==4">
	                    	tsi_contract_price desc
		                </when>
		            </choose>
		        	<choose>
		                <when test="order==0 and idx==5">
	                    	tpi_price asc
		                </when>
		                <when test="order==1 and idx==5">
	                    	tpi_price desc
		                </when>
		            </choose>
		        	<choose>
		                <when test="order==0 and idx==6">
	                    	tpi_response_date asc
		                </when>
		                <when test="order==1 and idx==6">
	                    	tpi_response_date desc
		                </when>
		            </choose>
	        	</foreach>
<!-- 	            ,tsi_confirm_level desc,tsi_code asc,tpi_code asc -->
	        </when>
	        <otherwise>
	        	order by tsi_confirm_level desc,tsi_code asc,tpi_code asc
	        </otherwise>
	    </choose>
		<if test="exportExcel == null or exportExcel != 1">
 			offset(${pageIndex}-1)*${listCount} row fetch next ${listCount} row only
 		</if> 
	</select>

	<insert id="insert_contract_purchaseinfo" parameterType="java.util.Map" useGeneratedKeys="true" keyProperty="autoTciCode">
		insert into tbl_contract_info(
			tci_tmicode,
			tci_tgicode,
			tci_tsicode,
			tci_product_cost,
			tci_product_vat,
			tci_contract_rate,
  			tci_confirm_level)
		values(
	        ${userCode},
	        ${userGroupCode},
	        ${salesCode},
	        #{productCost},
	        #{productCostVat},
	        #{productRate},
	        0)
	</insert>
	 
	<update id="update_contract_purchaseinfo" parameterType="java.util.Map">
		update tbl_contract_info set
			tci_tmicode=${userCode},
			tci_tgicode=${userGroupCode},
			tci_tsicode=${salesCode},
			tci_product_cost=#{productCost},
			tci_product_vat=#{productCostVat},
			tci_contract_rate=#{productRate} where tci_code=${contractCode}
	</update> 
	
	<delete id="delete_contract_items"  parameterType="int"> 
		delete from tbl_purchase_product where tpp_tsicode=${value};
		delete from tbl_install_work where tiw_tsicode=${value};
   	</delete>
   	
	<delete id="delete_sales_produceinfo"  parameterType="int"> 
		delete from tbl_purchase_product where tpp_tsicode=${value};
   	</delete>
   	
	<delete id="delete_sales_installworkinfo"  parameterType="int"> 
		delete from tbl_install_work where tiw_tsicode=${value};
   	</delete>
	
	<select id="select_exist_productcompany" resultType="int" parameterType="String">
		select top 1 tpc_code from tbl_product_company where tpc_name=#{_parameter}
	</select>
		
	<select id="select_exist_productname" resultType="int" parameterType="String">
		select top 1 tpi_code from tbl_product_info where tpi_name=#{_parameter}
	</select>	
	
	<insert id="insert_product_company" parameterType="java.util.Map" useGeneratedKeys="true" keyProperty="autoTpcCode">
		insert into tbl_product_company(
			tpc_name)
		values(
	        #{productComapny})
	</insert>
	 
	<insert id="insert_product_name" parameterType="java.util.Map" useGeneratedKeys="true" keyProperty="autoTpiCode">
		insert into tbl_product_info(
			tpi_name)
		values(
	        #{productName})
	</insert> 
	
	<insert id="insert_contract_product" parameterType="java.util.Map" useGeneratedKeys="true" keyProperty="autoTppCode">
		insert into tbl_purchase_product(
			tpp_tsicode,
<!-- 			tpp_tpccode, -->
			tpp_count,
			tpp_price,
			tpp_price_vat,
			tpp_rate,
			tpp_memo,
<!-- 			tpp_tpicode, -->
			tpp_company_name,
			tpp_product_name
			)
		values(
	        ${salesCode},
<!-- 	        ${companyCode}, -->
	        ${productCount},
	        #{productPrice},
	        #{productPriceVat},
	        #{productRate},
	        #{productMemo},
<!-- 	        #{productCode}, -->
	        #{productCompany},
	        #{productName}
	        )
	</insert>
	 
	<select id="select_exist_workcompany" resultType="int" parameterType="String">
		select top 1 twc_code from tbl_work_company where twc_name=#{_parameter}
	</select>
		
	<select id="select_exist_workname" resultType="int" parameterType="String">
		select top 1 twi_code from tbl_work_info where twi_name=#{_parameter}
	</select>	
	
	<insert id="insert_work_company" parameterType="java.util.Map" useGeneratedKeys="true" keyProperty="autoTwcCode">
		insert into tbl_work_company(
			twc_name)
		values(
	        #{workCompany})
	</insert>
	 
	<insert id="insert_work_name" parameterType="java.util.Map" useGeneratedKeys="true" keyProperty="autoTwiCode">
		insert into tbl_work_info(
			twi_name)
		values(
	        #{workName})
	</insert> 
	
	<insert id="insert_contract_work" parameterType="java.util.Map" useGeneratedKeys="true" keyProperty="autoTiwCode">
		insert into tbl_install_work(
			tiw_tsicode,
<!-- 			tiw_twccode, -->
			tiw_count,
			tiw_price,
			tiw_price_vat,
			tiw_rate,
			tiw_memo,
<!-- 			tiw_twicode, -->
			tiw_company_name,
			tiw_work_name
			)
		values(
	        ${salesCode},
<!-- 	        ${companyCode}, -->
	        ${workCount},
	        #{workPrice},
	        #{workPriceVat},
	        #{workRate},
	        #{workMemo},
<!-- 	        #{workCode}, -->
	        #{workCompany},
	        #{workName}
	        )
	</insert> 
	
	<update id="update_confirm_level" parameterType="java.util.Map">
		update tbl_sales_info set tsi_confirm_level=${confirmLevel} where tsi_code=${salesCode}
	</update>
</mapper>
